<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Simple CRM ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #f4f6fa;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            background: white;
            border-radius: 28px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.05);
            padding: 20px;
        }
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #0b1b32;
            margin-bottom: 4px;
        }
        .subtitle {
            color: #5a6a7e;
            font-size: 0.95rem;
            margin-bottom: 16px;
            border-bottom: 1px solid #e9edf2;
            padding-bottom: 12px;
        }
        .pricing {
            background: #eef2f6;
            border-radius: 18px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .plan {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .badge {
            border-radius: 40px;
            padding: 6px 14px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .badge.free {
            background: white;
            border: 1px solid #cbd5e1;
            color: #334155;
        }
        .badge.pro {
            background: #0b1b32;
            color: white;
        }
        .price {
            font-weight: 700;
            font-size: 1.1rem;
            color: #0b1b32;
        }
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            background: #f0f3f7;
            padding: 6px;
            border-radius: 40px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1 1 auto;
            text-align: center;
            padding: 10px 8px;
            font-weight: 500;
            border-radius: 30px;
            background: transparent;
            border: none;
            font-size: 0.9rem;
            color: #4a5a6e;
            transition: 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }
        .tab.active {
            background: white;
            color: #0b1b32;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            font-weight: 600;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .search-box {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
        }
        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #dce3ec;
            border-radius: 40px;
            font-size: 1rem;
            background: white;
        }
        .list-container {
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .list-item {
            background: #fafbfd;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid #e9edf2;
            transition: 0.1s;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .item-header h4 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .item-info {
            font-size: 0.9rem;
            color: #5f6c80;
            margin-bottom: 8px;
        }
        .item-info p {
            margin: 4px 0;
        }
        .item-meta {
            font-size: 0.8rem;
            color: #8a99aa;
            border-top: 1px dashed #dce3ec;
            padding-top: 8px;
            margin-top: 8px;
        }
        .item-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .comment-section {
            background: #f0f3f7;
            border-radius: 16px;
            padding: 12px;
            margin-top: 10px;
        }
        .comment {
            background: white;
            border-radius: 12px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .comment-author {
            font-weight: 600;
            color: #0b1b32;
            margin-bottom: 2px;
        }
        .comment-text {
            color: #1e293b;
        }
        .comment-time {
            font-size: 0.7rem;
            color: #8a99aa;
            margin-top: 4px;
            text-align: right;
        }
        .add-comment {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .add-comment input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #dce3ec;
            border-radius: 30px;
            font-size: 0.9rem;
        }
        button {
            background: white;
            border: 1px solid #d0d9e4;
            border-radius: 30px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            color: #1e293b;
        }
        button.primary {
            background: #0b1b32;
            border-color: #0b1b32;
            color: white;
        }
        button.small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        .add-button {
            width: 100%;
            padding: 14px;
            background: #0b1b32;
            color: white;
            border: none;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1rem;
            margin: 10px 0 5px;
        }
        .empty-state {
            text-align: center;
            color: #8a99aa;
            padding: 30px 20px;
            background: #f9fbfd;
            border-radius: 28px;
            font-size: 1rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            max-width: 500px;
            width: 100%;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        .modal-content input,
        .modal-content textarea,
        .modal-content select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #dce3ec;
            border-radius: 40px;
            font-size: 1rem;
            margin-bottom: 16px;
            background: white;
        }
        .modal-content textarea {
            border-radius: 24px;
            min-height: 100px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .modal-actions button {
            flex: 1;
            padding: 14px;
        }
        .limit-warning {
            background: #fff1e0;
            border-radius: 40px;
            padding: 12px 18px;
            font-size: 0.9rem;
            color: #a15400;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .integration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        .integration-item {
            background: #f0f3f7;
            border-radius: 16px;
            padding: 16px 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
            color: #0b1b32;
            border: 1px solid #dce3ec;
        }
        .footer-note {
            margin-top: 30px;
            font-size: 0.8rem;
            color: #8b99aa;
            text-align: center;
        }
        .rights {
            display: flex;
            gap: 8px;
            background: #f0f3f7;
            border-radius: 30px;
            padding: 8px;
            margin: 15px 0;
        }
        .role-btn {
            flex: 1;
            padding: 8px;
            border-radius: 30px;
            border: none;
            background: transparent;
            font-weight: 500;
            color: #4a5a6e;
        }
        .role-btn.active {
            background: white;
            color: #0b1b32;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
<div class="app">
    <h1>Simple CRM</h1>
    <div class="subtitle">–≤—Å—ë –¥–ª—è –ø—Ä–æ–¥–∞–∂</div>

    <!-- –¢–∞—Ä–∏—Ñ—ã -->
    <div class="pricing">
        <div class="plan">
            <span class="badge free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
            <span class="badge pro">PRO 990 ‚ÇΩ/–º–µ—Å</span>
        </div>
        <div class="price" id="contact-counter">0 / 10 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
    </div>
    <div id="limit-warning" class="limit-warning" style="display: none;">
        ‚ö†Ô∏è –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (10) –∏—Å—á–µ—Ä–ø–∞–Ω. –£–¥–∞–ª–∏—Ç–µ –ª–∏—à–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ PRO.
    </div>

    <!-- –†–æ–ª–∏ (–¥–µ–º–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞) -->
    <div class="rights">
        <button class="role-btn active" data-role="all">–í—Å–µ —Å–¥–µ–ª–∫–∏</button>
        <button class="role-btn" data-role="my">–¢–æ–ª—å–∫–æ –º–æ–∏</button>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div class="tabs">
        <button class="tab active" data-tab="contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
        <button class="tab" data-tab="deals">–°–¥–µ–ª–∫–∏</button>
        <button class="tab" data-tab="tasks">–ó–∞–¥–∞—á–∏</button>
        <button class="tab" data-tab="comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
        <button class="tab" data-tab="integrations">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</button>
    </div>

    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
    <div id="contacts" class="section active">
        <div class="search-box">
            <input type="text" id="search-contacts" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º">
        </div>
        <div id="contacts-list" class="list-container"></div>
        <button class="add-button" id="show-add-contact">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
    </div>

    <!-- –°–¥–µ–ª–∫–∏ -->
    <div id="deals" class="section">
        <div class="search-box">
            <input type="text" id="search-deals" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–¥–µ–ª–∫–∞–º">
        </div>
        <div id="deals-list" class="list-container"></div>
        <button class="add-button" id="show-add-deal">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
    </div>

    <!-- –ó–∞–¥–∞—á–∏ -->
    <div id="tasks" class="section">
        <div class="search-box">
            <input type="text" id="search-tasks" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º">
        </div>
        <div id="tasks-list" class="list-container"></div>
        <button class="add-button" id="show-add-task">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–æ–±—â–∏–π —á–∞—Ç –ø–æ —Å–¥–µ–ª–∫–∞–º) -->
    <div id="comments" class="section">
        <div id="comments-list" class="list-container"></div>
        <div class="add-form" style="margin-top: 10px;">
            <select id="comment-deal-select" style="width:100%; padding:12px; border-radius:40px; margin-bottom:10px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–¥–µ–ª–∫—É</option>
            </select>
            <input type="text" id="comment-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
            <button class="primary" id="add-comment-btn" style="width:100%; margin-top:10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–¥–µ–º–æ) -->
    <div id="integrations" class="section">
        <div class="integration-grid">
            <div class="integration-item">üìß Email</div>
            <div class="integration-item">üìû –¢–µ–ª–µ—Ñ–æ–Ω–∏—è</div>
            <div class="integration-item">üì± WhatsApp</div>
            <div class="integration-item">‚úàÔ∏è Telegram</div>
            <div class="integration-item">üìä Excel</div>
            <div class="integration-item">üîå API</div>
        </div>
        <p style="color: #5f6c80; text-align: center;">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞</p>
    </div>

    <div class="footer-note">
        ‚ú® –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∑–∞–¥–∞—á–∞–º–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏, –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</h3>
        <div id="modal-fields"></div>
        <div class="modal-actions">
            <button id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" id="modal-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // ----- –•—Ä–∞–Ω–∏–ª–∏—â–µ -----
        const STORAGE_KEYS = {
            CONTACTS: 'crm_contacts_full',
            DEALS: 'crm_deals_full',
            TASKS: 'crm_tasks_full',
            COMMENTS: 'crm_comments_full'
        };

        class Storage {
            static get(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            }
            static set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }
        }

        // ----- –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -----
        if (Storage.get(STORAGE_KEYS.CONTACTS).length === 0) {
            Storage.set(STORAGE_KEYS.CONTACTS, [
                { id: Date.now() + 1, name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', company: '–û–û–û "–†–æ–º–∞—à–∫–∞"', phone: '+7 999 123-45-67', email: 'ivan@example.com', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä 1' },
                { id: Date.now() + 2, name: '–û–ª—å–≥–∞ –°–º–∏—Ä–Ω–æ–≤–∞', company: '–ò–ü –°–º–∏—Ä–Ω–æ–≤–∞', phone: '+7 999 765-43-21', email: 'olga@example.com', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä 2' }
            ]);
        }
        if (Storage.get(STORAGE_KEYS.DEALS).length === 0) {
            Storage.set(STORAGE_KEYS.DEALS, [
                { id: Date.now() + 3, title: '–°–∞–π—Ç –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞', value: 150000, stage: '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', contactId: 1, manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä 1' },
                { id: Date.now() + 4, title: '–ü–æ—Å—Ç–∞–≤–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', value: 320000, stage: '–û—Ü–µ–Ω–∫–∞', contactId: 2, manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä 2' }
            ]);
        }
        if (Storage.get(STORAGE_KEYS.TASKS).length === 0) {
            Storage.set(STORAGE_KEYS.TASKS, [
                { id: Date.now() + 5, title: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –ò–≤–∞–Ω—É', dueDate: '2026-03-01', completed: false, dealId: 3, manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä 1' },
                { id: Date.now() + 6, title: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü', dueDate: '2026-03-02', completed: false, dealId: 4, manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä 2' }
            ]);
        }
        if (Storage.get(STORAGE_KEYS.COMMENTS).length === 0) {
            Storage.set(STORAGE_KEYS.COMMENTS, [
                { id: Date.now() + 7, dealId: 3, text: '–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–∫–∏–¥–∫—É', author: '–ú–µ–Ω–µ–¥–∂–µ—Ä 1', time: new Date().toISOString() },
                { id: Date.now() + 8, dealId: 4, text: '–ñ–¥–µ–º —Ä–µ—à–µ–Ω–∏–µ', author: '–ú–µ–Ω–µ–¥–∂–µ—Ä 2', time: new Date().toISOString() }
            ]);
        }

        // ----- –°–æ—Å—Ç–æ—è–Ω–∏–µ -----
        let currentRole = 'all'; // 'all' –∏–ª–∏ 'my'
        let currentUser = '–ú–µ–Ω–µ–¥–∂–µ—Ä 1'; // –¥–ª—è –¥–µ–º–æ
        let searchTerms = { contacts: '', deals: '', tasks: '' };
        let editingId = null;

        // ----- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ -----
        function generateId() {
            return Date.now() + Math.floor(Math.random() * 10000);
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('ru-RU');
        }

        // ----- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º –∏ –ø–æ–∏—Å–∫—É -----
        function filterByRole(items) {
            if (currentRole === 'my') {
                return items.filter(item => item.manager === currentUser);
            }
            return items;
        }

        function filterBySearch(items, type) {
            const term = searchTerms[type]?.toLowerCase() || '';
            if (!term) return items;
            if (type === 'contacts') {
                return items.filter(c => 
                    c.name?.toLowerCase().includes(term) || 
                    c.company?.toLowerCase().includes(term)
                );
            } else if (type === 'deals') {
                return items.filter(d => 
                    d.title?.toLowerCase().includes(term) ||
                    d.stage?.toLowerCase().includes(term)
                );
            } else if (type === 'tasks') {
                return items.filter(t => 
                    t.title?.toLowerCase().includes(term)
                );
            }
            return items;
        }

        // ----- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -----
        function updatePricingInfo() {
            const contacts = Storage.get(STORAGE_KEYS.CONTACTS);
            document.getElementById('contact-counter').innerText = `${contacts.length} / 10 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤`;
            document.getElementById('limit-warning').style.display = contacts.length >= 10 ? 'flex' : 'none';
        }

        // ----- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ -----
        function renderContacts() {
            let contacts = Storage.get(STORAGE_KEYS.CONTACTS);
            contacts = filterByRole(contacts);
            contacts = filterBySearch(contacts, 'contacts');
            
            const container = document.getElementById('contacts-list');
            if (contacts.length === 0) {
                container.innerHTML = '<div class="empty-state">ü§∑ –ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>';
                return;
            }

            container.innerHTML = contacts.map(contact => `
                <div class="list-item" data-id="${contact.id}">
                    <div class="item-header">
                        <h4>${escapeHtml(contact.name)}</h4>
                        <div class="item-actions">
                            <button class="small edit-contact" data-id="${contact.id}">‚úé</button>
                            <button class="small delete-contact" data-id="${contact.id}">‚úï</button>
                        </div>
                    </div>
                    <div class="item-info">
                        <p>üè¢ ${escapeHtml(contact.company || '‚Äî')}</p>
                        <p>üìû ${escapeHtml(contact.phone || '‚Äî')}</p>
                        <p>‚úâÔ∏è ${escapeHtml(contact.email || '‚Äî')}</p>
                    </div>
                    <div class="item-meta">
                        –ú–µ–Ω–µ–¥–∂–µ—Ä: ${escapeHtml(contact.manager || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω')}
                    </div>
                </div>
            `).join('');
        }

        function renderDeals() {
            let deals = Storage.get(STORAGE_KEYS.DEALS);
            const contacts = Storage.get(STORAGE_KEYS.CONTACTS);
            deals = filterByRole(deals);
            deals = filterBySearch(deals, 'deals');

            const container = document.getElementById('deals-list');
            if (deals.length === 0) {
                container.innerHTML = '<div class="empty-state">üíº –ù–µ—Ç —Å–¥–µ–ª–æ–∫</div>';
                return;
            }

            container.innerHTML = deals.map(deal => {
                const contact = contacts.find(c => c.id === deal.contactId);
                return `
                <div class="list-item" data-id="${deal.id}">
                    <div class="item-header">
                        <h4>${escapeHtml(deal.title)}</h4>
                        <div class="item-actions">
                            <button class="small edit-deal" data-id="${deal.id}">‚úé</button>
                            <button class="small delete-deal" data-id="${deal.id}">‚úï</button>
                        </div>
                    </div>
                    <div class="item-info">
                        <p>üí∞ ${deal.value?.toLocaleString() || 0} ‚ÇΩ</p>
                        <p>üìå –≠—Ç–∞–ø: ${escapeHtml(deal.stage)}</p>
                        <p>üë§ –ö–æ–Ω—Ç–∞–∫—Ç: ${contact ? escapeHtml(contact.name) : '‚Äî'}</p>
                    </div>
                    <div class="item-meta">
                        –ú–µ–Ω–µ–¥–∂–µ—Ä: ${escapeHtml(deal.manager || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω')}
                    </div>
                </div>
            `}).join('');
        }

        function renderTasks() {
            let tasks = Storage.get(STORAGE_KEYS.TASKS);
            const deals = Storage.get(STORAGE_KEYS.DEALS);
            tasks = filterByRole(tasks);
            tasks = filterBySearch(tasks, 'tasks');

            const container = document.getElementById('tasks-list');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">‚úÖ –ù–µ—Ç –∑–∞–¥–∞—á</div>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const deal = deals.find(d => d.id === task.dealId);
                return `
                <div class="list-item" data-id="${task.id}">
                    <div class="item-header">
                        <h4 style="${task.completed ? 'text-decoration: line-through; opacity:0.7;' : ''}">${escapeHtml(task.title)}</h4>
                        <div class="item-actions">
                            <button class="small toggle-task" data-id="${task.id}">${task.completed ? '‚Ü©Ô∏è' : '‚úÖ'}</button>
                            <button class="small edit-task" data-id="${task.id}">‚úé</button>
                            <button class="small delete-task" data-id="${task.id}">‚úï</button>
                        </div>
                    </div>
                    <div class="item-info">
                        <p>üìÖ ${formatDate(task.dueDate)}</p>
                        <p>üìå –°–¥–µ–ª–∫–∞: ${deal ? escapeHtml(deal.title) : '‚Äî'}</p>
                    </div>
                    <div class="item-meta">
                        –ú–µ–Ω–µ–¥–∂–µ—Ä: ${escapeHtml(task.manager || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω')}
                    </div>
                </div>
            `}).join('');
        }

        function renderComments() {
            let comments = Storage.get(STORAGE_KEYS.COMMENTS);
            const deals = Storage.get(STORAGE_KEYS.DEALS);
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            comments.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            const container = document.getElementById('comments-list');
            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state">üí¨ –ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
                return;
            }

            container.innerHTML = comments.map(comment => {
                const deal = deals.find(d => d.id === comment.dealId);
                return `
                <div class="list-item">
                    <div class="comment">
                        <div class="comment-author">${escapeHtml(comment.author || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div>
                        <div class="comment-text">${escapeHtml(comment.text)}</div>
                        <div class="comment-time">–ø–æ —Å–¥–µ–ª–∫–µ: ${deal ? escapeHtml(deal.title) : '‚Äî'} ‚Ä¢ ${new Date(comment.time).toLocaleString()}</div>
                    </div>
                </div>
            `}).join('');

            // –û–±–Ω–æ–≤–∏—Ç—å select —Å–æ —Å–¥–µ–ª–∫–∞–º–∏
            const select = document.getElementById('comment-deal-select');
            if (select) {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–¥–µ–ª–∫—É</option>' + 
                    deals.map(d => `<option value="${d.id}">${escapeHtml(d.title)}</option>`).join('');
            }
        }

        function renderAll() {
            renderContacts();
            renderDeals();
            renderTasks();
            renderComments();
            updatePricingInfo();
        }

        // ----- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -----
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalFields = document.getElementById('modal-fields');
        const modalSave = document.getElementById('modal-save');
        const modalCancel = document.getElementById('modal-cancel');

        function openModal(type, editData = null) {
            editingId = editData ? editData.id : null;
            let fieldsHtml = '';
            const contacts = Storage.get(STORAGE_KEYS.CONTACTS);
            const deals = Storage.get(STORAGE_KEYS.DEALS);

            if (type === 'contact') {
                modalTitle.innerText = editData ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç' : '–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç';
                fieldsHtml = `
                    <input type="text" id="modal-contact-name" placeholder="–ò–º—è *" value="${escapeHtml(editData?.name || '')}">
                    <input type="text" id="modal-contact-company" placeholder="–ö–æ–º–ø–∞–Ω–∏—è" value="${escapeHtml(editData?.company || '')}">
                    <input type="tel" id="modal-contact-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${escapeHtml(editData?.phone || '')}">
                    <input type="email" id="modal-contact-email" placeholder="Email" value="${escapeHtml(editData?.email || '')}">
                    <select id="modal-contact-manager">
                        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 1" ${editData?.manager === '–ú–µ–Ω–µ–¥–∂–µ—Ä 1' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä 1</option>
                        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 2" ${editData?.manager === '–ú–µ–Ω–µ–¥–∂–µ—Ä 2' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä 2</option>
                    </select>
                `;
            } else if (type === 'deal') {
                modalTitle.innerText = editData ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É' : '–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞';
                const stages = ['–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã', '–û—Ü–µ–Ω–∫–∞', '–£—Å–ø–µ—Ö', '–ü—Ä–æ–≤–∞–ª'];
                const options = stages.map(s => `<option value="${s}" ${editData?.stage === s ? 'selected' : ''}>${s}</option>`).join('');
                const contactOptions = contacts.map(c => `<option value="${c.id}" ${editData?.contactId === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>`).join('');
                fieldsHtml = `
                    <input type="text" id="modal-deal-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ *" value="${escapeHtml(editData?.title || '')}">
                    <input type="number" id="modal-deal-value" placeholder="–°—É–º–º–∞" value="${editData?.value || ''}">
                    <select id="modal-deal-stage">${options}</select>
                    <select id="modal-deal-contact">${contactOptions}</select>
                    <select id="modal-deal-manager">
                        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 1" ${editData?.manager === '–ú–µ–Ω–µ–¥–∂–µ—Ä 1' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä 1</option>
                        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 2" ${editData?.manager === '–ú–µ–Ω–µ–¥–∂–µ—Ä 2' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä 2</option>
                    </select>
                `;
            } else if (type === 'task') {
                modalTitle.innerText = editData ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É' : '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
                const dealOptions = deals.map(d => `<option value="${d.id}" ${editData?.dealId === d.id ? 'selected' : ''}>${escapeHtml(d.title)}</option>`).join('');
                fieldsHtml = `
                    <input type="text" id="modal-task-title" placeholder="–ó–∞–¥–∞—á–∞ *" value="${escapeHtml(editData?.title || '')}">
                    <input type="date" id="modal-task-due" value="${editData?.dueDate || ''}">
                    <select id="modal-task-deal">${dealOptions}</select>
                    <select id="modal-task-manager">
                        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 1" ${editData?.manager === '–ú–µ–Ω–µ–¥–∂–µ—Ä 1' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä 1</option>
                        <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 2" ${editData?.manager === '–ú–µ–Ω–µ–¥–∂–µ—Ä 2' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä 2</option>
                    </select>
                `;
            }
            modalFields.innerHTML = fieldsHtml;
            modal.classList.add('active');
            modalSave.dataset.type = type;
        }

        function closeModal() {
            modal.classList.remove('active');
            editingId = null;
        }

        modalCancel.addEventListener('click', closeModal);

        modalSave.addEventListener('click', () => {
            const type = modalSave.dataset.type;
            
            if (type === 'contact') {
                const name = document.getElementById('modal-contact-name')?.value.trim();
                if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
                const contacts = Storage.get(STORAGE_KEYS.CONTACTS);
                if (!editingId && contacts.length >= 10) {
                    alert('–õ–∏–º–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ 10');
                    closeModal();
                    return;
                }
                const newContact = {
                    id: editingId || generateId(),
                    name,
                    company: document.getElementById('modal-contact-company')?.value.trim() || '',
                    phone: document.getElementById('modal-contact-phone')?.value.trim() || '',
                    email: document.getElementById('modal-contact-email')?.value.trim() || '',
                    manager: document.getElementById('modal-contact-manager')?.value || '–ú–µ–Ω–µ–¥–∂–µ—Ä 1'
                };
                if (editingId) {
                    const index = contacts.findIndex(c => c.id === editingId);
                    if (index !== -1) contacts[index] = newContact;
                } else {
                    contacts.push(newContact);
                }
                Storage.set(STORAGE_KEYS.CONTACTS, contacts);
                renderContacts();
                updatePricingInfo();
            } 
            else if (type === 'deal') {
                const title = document.getElementById('modal-deal-title')?.value.trim();
                if (!title) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
                const deals = Storage.get(STORAGE_KEYS.DEALS);
                const newDeal = {
                    id: editingId || generateId(),
                    title,
                    value: parseFloat(document.getElementById('modal-deal-value')?.value) || 0,
                    stage: document.getElementById('modal-deal-stage')?.value || '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',
                    contactId: parseInt(document.getElementById('modal-deal-contact')?.value) || null,
                    manager: document.getElementById('modal-deal-manager')?.value || '–ú–µ–Ω–µ–¥–∂–µ—Ä 1'
                };
                if (editingId) {
                    const index = deals.findIndex(d => d.id === editingId);
                    if (index !== -1) deals[index] = newDeal;
                } else {
                    deals.push(newDeal);
                }
                Storage.set(STORAGE_KEYS.DEALS, deals);
                renderDeals();
            }
            else if (type === 'task') {
                const title = document.getElementById('modal-task-title')?.value.trim();
                if (!title) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É'); return; }
                const tasks = Storage.get(STORAGE_KEYS.TASKS);
                const newTask = {
                    id: editingId || generateId(),
                    title,
                    dueDate: document.getElementById('modal-task-due')?.value || '',
                    completed: editData?.completed || false,
                    dealId: parseInt(document.getElementById('modal-task-deal')?.value) || null,
                    manager: document.getElementById('modal-task-manager')?.value || '–ú–µ–Ω–µ–¥–∂–µ—Ä 1'
                };
                if (editingId) {
                    const index = tasks.findIndex(t => t.id === editingId);
                    if (index !== -1) {
                        newTask.completed = tasks[index].completed; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
                        tasks[index] = newTask;
                    }
                } else {
                    tasks.push(newTask);
                }
                Storage.set(STORAGE_KEYS.TASKS, tasks);
                renderTasks();
            }
            closeModal();
        });

        // ----- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ -----
        document.getElementById('show-add-contact').addEventListener('click', () => openModal('contact'));
        document.getElementById('show-add-deal').addEventListener('click', () => openModal('deal'));
        document.getElementById('show-add-task').addEventListener('click', () => openModal('task'));

        document.getElementById('add-comment-btn').addEventListener('click', () => {
            const dealId = parseInt(document.getElementById('comment-deal-select')?.value);
            const text = document.getElementById('comment-text')?.value.trim();
            if (!dealId || !text) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–¥–µ–ª–∫—É –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
                return;
            }
            const comments = Storage.get(STORAGE_KEYS.COMMENTS);
            comments.push({
                id: generateId(),
                dealId,
                text,
                author: currentUser,
                time: new Date().toISOString()
            });
            Storage.set(STORAGE_KEYS.COMMENTS, comments);
            document.getElementById('comment-text').value = '';
            renderComments();
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.addEventListener('click', (e) => {
            const id = Number(e.target.dataset.id);
            
            // –£–¥–∞–ª–µ–Ω–∏–µ
            if (e.target.classList.contains('delete-contact')) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç?')) return;
                let items = Storage.get(STORAGE_KEYS.CONTACTS);
                items = items.filter(i => i.id !== id);
                Storage.set(STORAGE_KEYS.CONTACTS, items);
                renderContacts();
                updatePricingInfo();
            }
            if (e.target.classList.contains('delete-deal')) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–¥–µ–ª–∫—É?')) return;
                let items = Storage.get(STORAGE_KEYS.DEALS);
                items = items.filter(i => i.id !== id);
                Storage.set(STORAGE_KEYS.DEALS, items);
                renderDeals();
            }
            if (e.target.classList.contains('delete-task')) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
                let items = Storage.get(STORAGE_KEYS.TASKS);
                items = items.filter(i => i.id !== id);
                Storage.set(STORAGE_KEYS.TASKS, items);
                renderTasks();
            }

            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (e.target.classList.contains('edit-contact')) {
                const items = Storage.get(STORAGE_KEYS.CONTACTS);
                const item = items.find(i => i.id === id);
                if (item) openModal('contact', item);
            }
            if (e.target.classList.contains('edit-deal')) {
                const items = Storage.get(STORAGE_KEYS.DEALS);
                const item = items.find(i => i.id === id);
                if (item) openModal('deal', item);
            }
            if (e.target.classList.contains('edit-task')) {
                const items = Storage.get(STORAGE_KEYS.TASKS);
                const item = items.find(i => i.id === id);
                if (item) openModal('task', item);
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
            if (e.target.classList.contains('toggle-task')) {
                const tasks = Storage.get(STORAGE_KEYS.TASKS);
                const task = tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    Storage.set(STORAGE_KEYS.TASKS, tasks);
                    renderTasks();
                }
            }
        });

        // –ü–æ–∏—Å–∫
        document.getElementById('search-contacts')?.addEventListener('input', (e) => {
            searchTerms.contacts = e.target.value;
            renderContacts();
        });
        document.getElementById('search-deals')?.addEventListener('input', (e) => {
            searchTerms.deals = e.target.value;
            renderDeals();
        });
        document.getElementById('search-tasks')?.addEventListener('input', (e) => {
            searchTerms.tasks = e.target.value;
            renderTasks();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRole = btn.dataset.role;
                renderAll();
            });
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const targetId = tab.dataset.tab;
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        renderAll();
    })();
</script>
</body>
</html>
